<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Imbull.com - Content editor V0.01</title>
    <style>
        html{font-family:sans-serif;}

    </style>
    <!--
    Loading Handsontable (full distribution that includes all dependencies apart from jQuery)
    -->
    <script data-jsfiddle="common" src="dist/handsontable.full.js"></script>
    <link data-jsfiddle="common" rel="stylesheet" media="screen" href="dist/handsontable.full.css">
    <link rel="stylesheet" media="screen" href="css/samples.css?20140331">
    <script  data-jsfiddle="common" src="js/samples.js"></script>
    <script src="js/highlight/highlight.pack.js"></script>
    <link rel="stylesheet" media="screen" href="js/highlight/styles/github.css">
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">


    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>



</head>
<div align="left">
<img src="http://www.tradetrackerbelgiumblog.be/wp-content/uploads/2013/06/logo-imbull.jpg" height="50">
    <p>You are now editing <span style="color:red; font-weight: bold;">Cupones</span></p>
    <a href="http://localhost:3000/api/getdata/cupones/json" target="_blank">Export JSON</a> | <a href="http://localhost:3000/api/getdata/cupones/csv">Export CSV</a> |
    <a href="http://localhost:3000/api/getdata/cupones/json" title="dont do that to often" target="_blank" style="color:red; font-weight: bold;">SCRAPE WEBSITE NOW!</a>
    <BR><BR>
</div>

<div class="wrapper">
    <div class="wrapper-row">



        <div id="example1" ></div>

                    <script>

                        shopName = "cupones";
                        loaded = false;

                        $.ajax({
                            context: document.body,
                            type: 'POST',
                            url: 'data.php',
                            success: function (data) {

                                myData = JSON.parse(data);
                                //myData.push();
                                myData.unshift();
                                hot.loadData(myData);
                            }
                        });


                        var
                                $ = function(id) {
                                    return document.getElementById(id);
                                },
                                container = $('example1'),
                                exampleConsole = $('example1console'),
                                autosave = $('autosave'),
                                load = $('load'),
                                save = $('save'),
                                autosaveNotification,
                                hot;

                        function negativeValueRenderer(instance, td, row, col, prop, value, cellProperties) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                            // if row contains negative number


                            if(col == 2) {
                                td.style.fontWeight = 'normal';
                                td.style.color = 'black';
                                td.style.background = '#f3c0c0';
                            }




                            if(col == 1 ) {
                                cellProperties.readOnly = true; // make cell read-only if it is first row or the text reads 'readOnly'
                            }





                            if (col == 2) {
                                // add class "negative"
                                ajax('http://localhost:3000/api/check_content/cupones', 'POST','content_hash='+value,  function (res) {
                                    if(res.responseText=="0") {
                                        td.style.fontWeight = 'normal';
                                        td.style.color = 'black';
                                        td.style.background = '#bfecc7';
                                    }
                                });


                            }





                        }




                        Handsontable.renderers.registerRenderer('negativeValueRenderer', negativeValueRenderer);

                        hot = new Handsontable(container, {
                            startRows: 1,
                            startCols: 1,
                            rowHeaders: true,
                            colHeaders: true,
                            minSpareRows: 0,
                            contextMenu: false,

                            colWidths: [200, 200, 800, 0],
                            colHeaders: ["Competitor", "Shopname", "Description"],
                            columnSorting: {
                                column: 1
                            },
                            afterOnCellMouseDown: function(){
                                loaded = true;
                                console.log("Handsontable initialized!");

                            },




                            cells: function (row, col, prop) {
                                var cellProperties = {};



                                cellProperties.renderer = "negativeValueRenderer"; // uses lookup map


                                return cellProperties;
                            },

                            afterChange: function (change, source) {
                                if (source === 'loadData') {

                                    return; //don't save this change
                                }


                                clearTimeout(autosaveNotification);
                                var oldValue = change[0][2];
                                var newValue = change[0][3];
                                var rowIndex = change[0][0];
                                var columnIndex = change[0][1];
                                ajax('http://localhost:3000/api/updatecode', 'POST', "newValue="+newValue+"&shopName=cupones&oldValue="+oldValue, function (res) {

                                });

                            }
                        });



                        Handsontable.Dom.addEvent(save, 'click', function() {

                            // save all cell's data
                            ajax('json/save.json', 'GET', JSON.stringify({data: hot.getData()}), function (res) {
                                var response = JSON.parse(res.response);

                                if (response.result === 'ok') {
                                    exampleConsole.innerText = 'Data saved';
                                }
                                else {
                                    exampleConsole.innerText = 'Save error';
                                }
                            });
                        });

                        Handsontable.Dom.addEvent(autosave, 'click', function() {

                            if (autosave.checked) {
                                exampleConsole.innerText = 'Changes will be autosaved';
                            }
                            else {
                                exampleConsole.innerText ='Changes will not be autosaved';
                            }
                        });


                    </script>

                </div>


        </div>

    </div>
</div>

<div id="outside-links-wrapper"></div>