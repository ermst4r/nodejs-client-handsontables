<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Load &amp; Save (Ajax) - Handsontable</title>

    <!--
    Loading Handsontable (full distribution that includes all dependencies apart from jQuery)
    -->
    <script data-jsfiddle="common" src="dist/handsontable.full.js"></script>
    <link data-jsfiddle="common" rel="stylesheet" media="screen" href="dist/handsontable.full.css">

    <!--
    Loading demo dependencies. They are used here only to enhance the examples on this page
    -->
    <link rel="stylesheet" media="screen" href="css/samples.css?20140331">
    <script  data-jsfiddle="common" src="js/samples.js"></script>
    <script src="js/highlight/highlight.pack.js"></script>
    <link rel="stylesheet" media="screen" href="js/highlight/styles/github.css">
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
    <
    <!--
    Facebook open graph. Don't copy this to your project :)
    -->
    <meta property="og:title" content="Load &amp; Save (Ajax)">
    <meta property="og:description"
          content="Use the onChange callback to track changes made in the table. In the example below, $.ajax is used to load and save grid data.">
    <meta property="og:url" content="http://handsontable.com/demo/ajax.html">
    <meta property="og:image" content="http://handsontable.com/demo/image/og-image.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="409">
    <meta property="og:image:height" content="164">

    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

</head>



<div class="wrapper">
    <div class="wrapper-row">
        <div id="global-menu-clone">
            <h1><a href="../index.html">Handsontable</a></h1>

        </div>

        <div id="container">
            <div class="columnLayout">

                <div class="rowLayout">
                    <div class="descLayout">
                        <div class="pad" data-jsfiddle="example1">
                            <h2>Load &amp; Save (Ajax)</h2>

                            <p>Use the
                                <b>onChange</b> callback to track changes made in the table. In the example below, $.ajax is used to load
                                and save grid data.
                            </p>

                            <p>Note: this is a mockup. Nothing is acually saved. You have to implement that part server-side.</p>

                            <p>
                                <button name="load" id="load">Load</button>
                                <button name="save" id="save">Save</button>
                                <label><input type="checkbox" name="autosave" id="autosave" checked="checked" autocomplete="off"> Autosave</label>
                            </p>

                            <pre id="example1console" class="console">Click "Load" to load data from server</pre>

                            <div id="example1"></div>

                            <p>
                                <button name="dump" data-dump="#example1" data-instance="hot" title="Prints current data source to Firebug/Chrome Dev Tools">
                                    Dump data to console
                                </button>
                            </p>
                        </div>
                    </div>



                    <script>

                        shopName = "cupones";
                        loaded = false;

                        $.ajax({
                            context: document.body,
                            type: 'POST',
                            data: 'active_veiling_id=',
                            url: 'data.php',
                            success: function (data) {

                                 myData = JSON.parse(data);
                                //myData.push();
                                myData.unshift({website:"erwin",shopName:"Shop",productName:"Productname"});
                                hot.loadData(myData);
                            }
                        });


                        var
                                $ = function(id) {
                                    return document.getElementById(id);
                                },
                                container = $('example1'),
                                exampleConsole = $('example1console'),
                                autosave = $('autosave'),
                                load = $('load'),
                                save = $('save'),
                                autosaveNotification,
                                hot;

                        function negativeValueRenderer(instance, td, row, col, prop, value, cellProperties) {
                            Handsontable.renderers.TextRenderer.apply(this, arguments);
                            // if row contains negative number
                            if(col == 2) {
                                td.style.fontWeight = 'normal';
                                td.style.color = 'black';
                                td.style.background = 'pink';
                            }

                             if(row == 0) {
                                 td.style.background = 'blue';
                                 td.style.color = 'white';
                                 cellProperties.readOnly = true; // make cell read-only if it is first row or the text reads 'readOnly'
                             }

                            if(col == 0 ) {
                                cellProperties.readOnly = true; // make cell read-only if it is first row or the text reads 'readOnly'
                            }

                            if(col == 1 ) {
                                cellProperties.readOnly = true; // make cell read-only if it is first row or the text reads 'readOnly'
                            }

                            if(value == -1) {
                                td.style.fontWeight = 'normal';
                                td.style.color = 'white';
                                td.style.background = 'green';
                            }



                            if (col == 2 && row >=1 && loaded == false) {
                                // add class "negative"
                                ajax('http://localhost:3000/api/check_content/cupones/'+value, 'GET',null,  function (res) {
                                    if(res.responseText=="0") {
                                        td.style.fontWeight = 'normal';
                                        td.style.color = 'white';
                                        td.style.background = 'green';
                                    }
                                });


                            }





                        }




                        Handsontable.renderers.registerRenderer('negativeValueRenderer', negativeValueRenderer);

                        hot = new Handsontable(container, {
                            startRows: 1,
                            startCols: 1,
                            rowHeaders: true,
                            colHeaders: true,
                            minSpareRows: 0,
                            contextMenu: true,
                            colWidths: [200, 200, 800, 0],
                            afterOnCellMouseDown: function(){
                                loaded = true;
                                console.log("Handsontable initialized!");

                            },




                            cells: function (row, col, prop) {
                                var cellProperties = {};



                                cellProperties.renderer = "negativeValueRenderer"; // uses lookup map


                                return cellProperties;
                            },

                            afterChange: function (change, source) {
                                if (source === 'loadData') {

                                    return; //don't save this change
                                }

                                clearTimeout(autosaveNotification);
                                var oldValue = change[0][2];
                                var newValue = change[0][3];
                                var rowIndex = change[0][0];

                                ajax('http://localhost:3000/api/updatecode', 'POST', "oldValue="+oldValue+"&newValue="+newValue+"&shopName="+shopName, function (res) {

                                });

                            }
                        });



                        Handsontable.Dom.addEvent(save, 'click', function() {

                            // save all cell's data
                            ajax('json/save.json', 'GET', JSON.stringify({data: hot.getData()}), function (res) {
                                var response = JSON.parse(res.response);

                                if (response.result === 'ok') {
                                    exampleConsole.innerText = 'Data saved';
                                }
                                else {
                                    exampleConsole.innerText = 'Save error';
                                }
                            });
                        });

                        Handsontable.Dom.addEvent(autosave, 'click', function() {

                            if (autosave.checked) {
                                exampleConsole.innerText = 'Changes will be autosaved';
                            }
                            else {
                                exampleConsole.innerText ='Changes will not be autosaved';
                            }
                        });


                    </script>

                </div>

                <div class="footer-text">
                </div>
            </div>

        </div>

    </div>
</div>

<div id="outside-links-wrapper"></div>